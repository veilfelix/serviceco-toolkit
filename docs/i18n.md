# Internationalization (i18n) Overview

This project supports full internationalization (i18n) using `next-i18next` and a scalable setup that ensures translations are available both client-side and server-side with optimal performance and developer experience.

---

## Stack

|Tool|Purpose|
|---|---|
|**next-i18next**|Manages locale-based translations, namespaces, and server-side hydration|
|**i18next**|Core translation engine used under the hood|
|**react-i18next**|React bindings for `i18next`|
|**LanguageSwitcher**|Component for toggling between locales via router|

---

## Architecture

### Namespaces

Translations are separated by **namespace**, allowing each component or domain to manage its own text content (e.g., `common`, `layout`, `a11y`, `header`, `footer`, `ui`, `composed`, `home`, `error`, etc.).

Namespaces are defined as JSON files in:

```
/public/locales/{locale}/{namespace}.json
```

---

## `getStaticProps` Requirement

To ensure translations are loaded **at build time**, any page that includes translatable content or SSR-rendered components **must** use `getStaticProps` and invoke our helper:

```
import { withSharedNamespaces } from '@/utils/i18n'

export const getStaticProps: GetStaticProps = async ({ locale = 'en' }) => {
  return {
    props: {
      ...(await withSharedNamespaces(locale, ['home'])) // home is the page-specific namespace
    },
  }
}
```

`withSharedNamespaces` merges core shared namespaces (`common`, `layout`, `a11y`, etc.) with any page-specific ones.

---

## `'use client'` and Layout Components

Due to how translations are resolved at runtime, using useTranslation() directly in layout-level components like Header, Footer, or SkipLink caused hydration mismatches where the server-rendered content did not match the client-rendered one.

This was particularly noticeable when calling t('header.siteTitle') would render the key name on first load or trigger hydration warnings.

### Fix Strategy

We initially explored conditional useEffect-based mounting, but this proved fragile and verbose.

Instead, we fixed this globally by:

1. Marking layout-level components like Header, Footer, and SkipLink as client components using 'use client'.

2. Ensuring every page explicitly calls getStaticProps and loads all the necessary namespaces upfront using withSharedNamespaces().

This guarantees translations are already available at render time and resolves all hydration issues without hacky mounted checks.

We then created a script to automate namespace syncing (see below).

## Jest Testing

When testing components using translations, the `t()` function must be initialized properly to avoid warnings like:

```
react-i18next:: You will need to pass in an i18next instance
```

We use a helper to set up i18n for tests:

```
// utils/i18n.ts
export function initTestI18n(resources = {}, lng = 'en') {
  i18n.use(initReactI18next).init({
    lng,
    fallbackLng: lng,
    debug: false,
    resources,
    interpolation: { escapeValue: false },
  })
  return i18n
}
```

Then inside your test file:

```
beforeEach(() => {
  initTestI18n({ en: { header: { siteTitle: 'Site Title' } } })
})
```

---

## Language Switcher

The `<LanguageSwitcher />` component switches languages using Next.js routing:

```
router.push(router.asPath, router.asPath, { locale: 'fr' })
```

It uses `router.locale`, `router.locales`, and `router.defaultLocale` to display and toggle available languages.

Under the hood, switching languages triggers a reload with a new i18n context.

---

## Automating Namespace Detection

We include a script to keep `defaultNamespaces` up to date with the translation files in `/public/locales/`:

```
node scripts/generate-default-namespaces.js
```

This scans your locales and outputs an updated array in `utils/i18n.ts` or wherever you define your shared namespaces.

You can hook this into a pre-commit script via Husky.

---

## Summary

|   |   |
|---|---|
|Area|Concern / Fix|
|SSR & hydration|Use `getStaticProps` + `withSharedNamespaces()`|
|Layout components|Mark as 'use client' and load their namespaces server-side. See our [use-client documentation](./use-client.md) for full details.|
|Tests with i18n|Setup with `initTestI18n()` and inject dummy translations|
|Switching language|Use `router.push(..., ..., { locale })`|
|Namespace sync|Run `generate-default-namespaces.js` to keep `defaultNamespaces` in sync|

This setup ensures reliable and maintainable internationalization support across SSR, CSR, and testing environments.

---

## File Structure Overview

```
src/  
├── utils/  
│ └── i18n.ts                           ← i18n helpers for SSR and tests (e.g. initTestI18n, withSharedNamespaces)  
public/  
└── locales/                            ← Translation files grouped by locale and namespace  
scripts/  
└── generate-default-namespaces.js      ← CLI to sync `defaultNamespaces` with available translation files  
.husky/  
└── pre-commit                          ← Git hook running namespace and client annotation checks
```